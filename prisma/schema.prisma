generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

model IndexerState {
  key               String    @id
  lastProcessedSlot BigInt    @map("last_processed_slot")
  lastSyncTime      DateTime? @map("last_sync_time")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("indexer_state")
}

model Merchant {
  walletAddress String         @id @map("wallet_address")
  companyName   String?        @map("company_name")
  email         String?
  logoUrl       String?        @map("logo_url")
  webhookUrl    String?        @map("webhook_url")
  webhookSecret String?        @map("webhook_secret")
  createdAt     DateTime       @default(now()) @map("created_at")
  plans         MerchantPlan[]

  @@map("merchants")
}

model MerchantPlan {
  planPda          String   @id @map("plan_pda")
  merchantWallet   String   @map("merchant_wallet")
  planId           String   @map("plan_id")
  planName         String   @map("plan_name")
  mint             String
  feeAmount        String   @map("fee_amount") // stored as string for BigInt
  paymentInterval  String   @map("payment_interval") // stored as string for BigInt
  isActive         Boolean  @default(true) @map("is_active")
  totalSubscribers Int      @default(0) @map("total_subscribers")
  totalRevenue     String   @default("0") @map("total_revenue")
  description      String?
  features         Json?
  category         String?
  createdAt        DateTime @default(now()) @map("created_at")

  merchant Merchant @relation(fields: [merchantWallet], references: [walletAddress])
  subscriptions Subscription[] @relation("PlanSubscriptions")

  @@index([merchantWallet])
  @@map("merchant_plans")
}

model Subscription {
  subscriptionPda       String    @id @map("subscription_pda")
  userWallet            String    @map("user_wallet")
  subscriptionWalletPda String    @map("subscription_wallet_pda")
  merchantWallet        String    @map("merchant_wallet")
  merchantPlanPda       String    @map("merchant_plan_pda")
  mint                  String
  feeAmount             String    @map("fee_amount")
  paymentInterval       String    @map("payment_interval")
  lastPaymentTimestamp  String    @map("last_payment_timestamp")
  totalPaid             String    @default("0") @map("total_paid")
  paymentCount          Int       @default(0) @map("payment_count")
  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  cancelledAt           DateTime? @map("cancelled_at")

  plan MerchantPlan @relation("PlanSubscriptions", fields: [merchantPlanPda], references: [planPda])

  @@index([userWallet])
  @@index([merchantWallet])
  @@index([subscriptionWalletPda])
  @@index([merchantPlanPda])
  @@map("subscriptions")
}

model SubscriptionWallet {
  walletPda          String   @id @map("wallet_pda")
  ownerWallet        String   @map("owner_wallet")
  mint               String
  isYieldEnabled     Boolean  @default(false) @map("is_yield_enabled")
  yieldStrategy      String?  @map("yield_strategy")
  yieldVault         String?  @map("yield_vault")
  totalSubscriptions Int      @default(0) @map("total_subscriptions")
  totalSpent         String   @default("0") @map("total_spent")
  createdAt          DateTime @default(now()) @map("created_at")

  @@index([ownerWallet])
  @@map("subscription_wallets")
}

model Transaction {
  id              String   @id @default(uuid())
  signature       String
  subscriptionPda String   @map("subscription_pda")
  type            String
  amount          String
  fromWallet      String   @map("from_wallet")
  toWallet        String   @map("to_wallet")
  blockTime       String   @map("block_time")
  slot            Int
  status          String   @default("success")
  indexedAt       DateTime @default(now()) @map("indexed_at")

  @@index([subscriptionPda])
  @@index([signature])
  @@map("transactions")
}

model ScheduledPayment {
  id              String    @id @default(uuid())
  subscriptionPda String    @map("subscription_pda")
  merchantWallet  String    @map("merchant_wallet")
  amount          String
  scheduledFor    DateTime  @map("scheduled_for")
  status          String    @default("pending")
  signature       String?
  errorMessage    String?   @map("error_message")
  retryCount      Int       @default(0) @map("retry_count")
  createdAt       DateTime  @default(now()) @map("created_at")
  executedAt      DateTime? @map("executed_at")

  @@index([subscriptionPda])
  @@index([scheduledFor])
  @@index([status])
  @@map("scheduled_payments")
}

model UserProfile {
  walletAddress             String   @id @map("wallet_address")
  email                     String?
  phone                     String?
  notificationPreferences   Json?    @map("notification_preferences")
  pushToken                 String?  @map("push_token")
  createdAt                 DateTime @default(now()) @map("created_at")

  @@map("user_profiles")
}

model WebhookLog {
  id                String    @id @default(uuid())
  merchantWallet    String    @map("merchant_wallet")
  event             String
  payload           Json
  webhookUrl        String    @map("webhook_url")
  status            String    // 'success', 'failed', 'pending'
  responseStatus    Int?      @map("response_status")
  responseBody      String?   @map("response_body")
  errorMessage      String?   @map("error_message")
  retryCount        Int       @default(0) @map("retry_count")
  deliveryTime      Int?      @map("delivery_time") // milliseconds
  createdAt         DateTime  @default(now()) @map("created_at")
  deliveredAt       DateTime? @map("delivered_at")

  @@index([merchantWallet])
  @@index([event])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_logs")
}

model WebhookEndpoint {
  id                String   @id @default(uuid())
  merchantWallet    String   @map("merchant_wallet")
  url               String
  secret            String
  isActive          Boolean  @default(true) @map("is_active")
  events            String[] // Array of event types to subscribe to
  description       String?
  lastSuccess       DateTime? @map("last_success")
  lastFailure       DateTime? @map("last_failure")
  totalSuccess      Int      @default(0) @map("total_success")
  totalFailure      Int      @default(0) @map("total_failure")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([merchantWallet, url])
  @@index([merchantWallet])
  @@map("webhook_endpoints")
}